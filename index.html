<!DOCTYPE html>
<html>
<head>
    <title>SlamData</title>
    <meta charset="utf-8">
    <link rel="stylesheet" type="text/css" href="bower_components/c3/c3.css">
    <link rel="stylesheet" type="text/css" href="bower_components/codemirror/lib/codemirror.css" />
    <link rel="stylesheet" type="text/css" href="bower_components/entypo/font/entypo.css" />
    <link rel="stylesheet" type="text/css" href="bower_components/fontawesome/css/font-awesome.css" />
    <link rel="stylesheet" type="text/css" href="bower_components/react-treeview/react-treeview.css">
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <script src="bower_components/c3/c3.js"></script>
    <script src="bower_components/codemirror/lib/codemirror.js"></script>
    <script src="bower_components/codemirror/mode/javascript/javascript.js"></script>
    <script src="bower_components/d3/d3.js" charset="utf-8"></script>
    <script src="bower_components/modernizr/modernizr.js"></script>
    <script src="bower_components/node-uuid/uuid.js"></script>
    <script src="bower_components/oboe/dist/oboe-browser.js"></script>
    <script src="bower_components/showdown/src/showdown.js"></script>
</head>
<body>
    <div id="content"></div>

    <script src="bower_components/react/react-with-addons.js"></script>
    <script src="bower_components/react-treeview/react-treeview.js"></script>
    <script src="bower_components/jquery/dist/jquery.js"></script>
    <script src="bower_components/underscore/underscore.js"></script>
    <script src="bower_components/underscore-contrib/underscore.object.builders.js"></script>
    <script src="bower_components/fastclick/lib/fastclick.js"></script>
    <script src="bower_components/foundation/js/foundation/foundation.js"></script>
    <script src="bower_components/foundation/js/foundation/foundation.topbar.js"></script>
    <script src="bower_components/tiny-emitter/dist/tinyemitter.js"></script>
    <script src="js/slamdata.js"></script>
    <script type="text/javascript">
        var Alternative = require('Control.Alternative');
        var Identity = require('Control.Monad.Identity');
        var Argonaut = require('Data.Argonaut');
        var ArgonautCore = require('Data.Argonaut.Core');
        var ArgonautPrinter = require('Data.Argonaut.Printer');
        var Either = require('Data.Either');
        var sd = require('SlamData');
        var helpers = require('SlamData.Helpers');
        var types = require('SlamData.Types');
        var jsTypes = require('SlamData.Types.JS');
        var blockTypes = require('SlamData.Types.Workspace.Notebook.Block');
        var Parser = require('Text.Parsing.Parser');
        var ParserCombinators = require('Text.Parsing.Parser.Combinators');
        var ParserString = require('Text.Parsing.Parser.String');
        // Load up slamdata.
        var state = {
            files: {
                name: helpers.defaultMountPath,
                type: 'directory',
                children: []
            },
            notebooks: [],
            settings: {
                sdConfig: helpers.defaultSDConfig,
                seConfig: helpers.defaultSEConfig
            },
            showSettings: false
        };
        // Start up an emitter to pass down to slamdata.
        var emitter = new TinyEmitter();
        var respond = function(data) {
            return emitter.emit(types.responseEvent, data);
        }
        var converter = new Showdown.converter();
        emitter.on(types.requestEvent, function(request) {
            var newEvent = request.event;
            // Mutation sucks.
            var newState = _.snapshot(request.state);
            if (jsTypes.isReadFileSystem(newEvent)) {
                var path = newEvent.value0;
                var dirs = ['/'].concat(path.split('/').slice(1, -1));
                var fs = helpers.serverURI(state.settings.sdConfig) + '/metadata/fs' + path;
                oboe(fs).done(function(files) {
                    var insertChildren = function(dirs, fs, children) {
                        if (dirs.length === 1 && dirs[0] === fs[0].name) {
                            var oldKids = fs[0].children;
                            fs[0].children = children.map(function(c) {
                                for (var i = 0; i < oldKids.length; ++i) {
                                    var oldKid = oldKids[i];
                                    if (oldKid.name == c.name && oldKid.type == c.type) {
                                        if (oldKid.children != null) {
                                            c.children = oldKid.children;
                                        } else {
                                            c.children = [];
                                        }
                                        return c;
                                    }
                                }
                                c.children = [];
                                return c;
                            })
                            return fs
                        } else if (dirs.length > 1 && dirs[0] === fs[0].name) {
                            var kids = insertChildren(dirs.slice(1), fs[0].children, children);
                            fs[0].children = kids;
                            return fs;
                        } else {
                            return [fs[0]].concat(insertChildren(dirs, fs.slice(1), children));
                        }
                    }
                    // var files1 = files.children.map(function(f) {
                    //     if  (f.children == null) {
                    //         f.children = [];
                    //     }
                    //     return f;
                    // })
                    newState.files = insertChildren(dirs, [newState.files], files.children)[0];
                    respond(newState);
                });
            } else if (jsTypes.isShowSettings(newEvent)) {
                newState.showSettings = true;
                respond(newState);
            } else if (jsTypes.isHideSettings(newEvent)) {
                newState.showSettings = false;
                respond(newState);
            } else if (jsTypes.isCreateNotebook(newEvent)) {
                var notebook = {
                    ident: uuid.v4(),
                    blocks: [],
                    name: "Untitled" + (newState.notebooks.length + 1),
                    path: "/"
                };
                var url = helpers.serverURI(state.settings.sdConfig) +
                    '/data/fs' + notebook.path + notebook.name + '/index.nb';
                $.ajax({
                    url: url,
                    type: 'POST',
                    data: JSON.stringify(notebook)
                }).done(function() {
                    newState.notebooks.push(notebook);
                    respond(newState);
                });
            } else if (jsTypes.isCloseNotebook(newEvent)) {
                var ident = newEvent.value0;
                newState.notebooks = newState.notebooks.filter(function(nb) {
                    return nb.ident !== ident;
                });
                respond(newState);
            } else if (jsTypes.isCreateBlock(newEvent)) {
                var newBlock = {
                    ident: uuid.v4(),
                    blockType: newEvent.value1,
                    blockMode: blockTypes.Edit.value,
                    editContent: '',
                    evalContent: ''
                };
                newState.notebooks = newState.notebooks.map(function(nb) {
                    if (nb.ident === newEvent.value0) {
                        nb.blocks.push(newBlock);
                    }
                    return nb;
                });
                respond(newState);
            } else if (jsTypes.isDeleteBlock(newEvent)) {
                newState.notebooks = newState.notebooks.map(function(nb) {
                    if (nb.ident === newEvent.value0) {
                        nb.blocks = nb.blocks.filter(function(b) {
                            return b.ident !== newEvent.value1;
                        });
                    }
                    return nb;
                });
                respond(newState);
            } else if (jsTypes.isEditBlock(newEvent)) {
                var block = newEvent.value1;
                var notebook = newEvent.value0;
                newState.notebooks = newState.notebooks.map(function(nb) {
                    if (nb.ident === notebook.ident) {
                        nb.blocks = nb.blocks.map(function(b) {
                            if (b.ident === block.ident) {
                                b.blockMode = blockTypes.Edit.value;
                            }
                            return b;
                        });
                    }
                    return nb;
                });
                respond(newState);
            } else if (jsTypes.isEvalBlock(newEvent)) {
                var block = newEvent.value1;
                var notebook = newEvent.value0;
                if (jsTypes.isMarkdown(block.blockType)) {
                    block.evalContent = converter.makeHtml(block.editContent);
                    newState.notebooks = newState.notebooks.map(function(nb) {
                        if (nb.ident === notebook.ident) {
                            nb.blocks = nb.blocks.map(function(b) {
                                if (b.ident === block.ident) {
                                    b.evalContent = block.evalContent;
                                    b.blockMode = blockTypes.Eval.value;
                                }
                                return b;
                            });
                        }
                        return nb;
                    });
                    respond(newState);
                } else if (jsTypes.isSQL(block.blockType)) {
                    var baseUrl = helpers.serverURI(state.settings.sdConfig);
                    var sqlBlocks = notebook.blocks.filter(function(b) {
                        return jsTypes.isSQL(b.blockType);
                    });
                    var url = baseUrl + '/query/fs' + notebook.path + '?out=' +
                        notebook.name + '/out' + sqlBlocks.length + '.json';
                    oboe({
                        url: url,
                        method: 'POST',
                        body: block.editContent,
                    }).done(function(data) {
                        var out = data.out;
                        var xhr = new XMLHttpRequest();
                        xhr.onload = function() {
                            newState.notebooks = newState.notebooks.map(function(nb) {
                                if (nb.ident === notebook.ident) {
                                    nb.blocks = nb.blocks.map(function(b) {
                                        if (b.ident === block.ident) {
                                            b.evalContent = xhr.responseText;
                                            b.blockMode = blockTypes.Eval.value;
                                        }
                                        return b;
                                    });
                                }
                                return nb;
                            });
                            respond(newState);
                        };
                        xhr.open('GET', baseUrl + '/data/fs' + out + '?limit=20');
                        xhr.send(null);
                    });
                }
            } else {
                // We can't do anything else, just pass it on back.
                respond(newState);
            }
        });
        require('SlamData').slamData(emitter)(state)();
        // We have to initialize any foundation stuff last.
        $(document).foundation();
    </script>
</body>
</html>
